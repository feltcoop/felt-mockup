<script>
	import ForumTopicsList from './ForumTopicsList.svelte';
	import ForumTopicsListItem from './ForumTopicsListItem.svelte';
	import ForumInput from './ForumInput.svelte';
	import Button from '@app/ui/Button.svelte';
	import data, { id } from '../../../routes/_data.js';
	import { slugify } from '@app/url/utils.js';

	export let topics;

	const { session } = data;

	export let titleValue = '';
	export let contentValue = '';

	$: hasDraft = Boolean(titleValue || contentValue);

	let showDraft = false;

	const toggleDraft = () => {
		showDraft = !showDraft;
	};

	export let titleEl;
	export let contentEl;

	$: slug = slugify(titleValue);

	const submit = () => {
		// console.log('submit content', titleValue, contentValue);
		if (!titleValue) {
			titleEl.focus();
			return;
		}
		topics = [
			{
				author: session.person.slug,
				id: id(),
				content: contentValue,
				title: titleValue,
				slug,
			},
			...topics,
		];
		titleValue = '';
		contentValue = '';
		toggleDraft();
	};
	const submitTitle = () => {
		// TODO how to advance to next form tab index?
		contentEl.focus();
	};
	const submitContent = () => {
		// TODO how to advance to next form tab index?
		titleEl.focus();
	};

	// TODO need a store per chat that saves the input state
</script>

<div class="flex flex-col h-full">
	<div class="mb-2">
		{#if showDraft}
			<Button on:click={toggleDraft}>~ stash draft</Button>
			<Button on:click={submit}>! publish this draft</Button>
		{:else if hasDraft}
			<Button on:click={toggleDraft}>+ resume draft</Button>
		{:else}
			<Button on:click={toggleDraft}>+ add a topic</Button>
		{/if}
	</div>
	{#if showDraft}
		<!-- TODO make this first one shorter -->
		<ForumInput
			bind:el={titleEl}
			bind:value={titleValue}
			placeholder="title.."
			submit={submitTitle} />
		<ForumInput
			bind:el={contentEl}
			bind:value={contentValue}
			placeholder="..content!"
			submit={submitContent}
			classes="border-t-0" />
		{#if hasDraft}
			<div class="border-4 border-purple-200 rounded-bl-lg rounded-tr-lg p-2">
				<ForumTopicsListItem
					topic={{ author: session.person.slug, slug, title: titleValue, content: contentValue }} />
				{@html contentValue}
			</div>
		{/if}
	{/if}
	<ForumTopicsList {topics} />
</div>
